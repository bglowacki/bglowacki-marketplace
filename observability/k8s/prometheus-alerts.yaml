apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: claude-code-alerts
  namespace: observability
  labels:
    release: prometheus
spec:
  groups:
    - name: claude_code_workflow
      interval: 1m
      rules:
        - alert: ClaudeCodeRepeatedFailures
          expr: |
            sum(increase(claude_code_outcome_failure_total[5m])) by (session_id, project) > 3
          for: 0m
          labels:
            severity: warning
          annotations:
            summary: "{{ $labels.project }}: 3+ failures in 5 minutes"

        - alert: ClaudeCodeStuckInImplementation
          expr: |
            sum(increase(claude_code_workflow_stage_transition_total{to_stage="implement"}[30m])) by (session_id) > 10
            and
            sum(increase(claude_code_workflow_stage_transition_total{to_stage=~"test|commit"}[30m])) by (session_id) == 0
          for: 5m
          labels:
            severity: info
          annotations:
            summary: "Session stuck in implementation without testing"

        - alert: ClaudeCodeContextChurn
          expr: |
            sum(increase(claude_code_context_compaction_total[1h])) by (project) > 5
          for: 0m
          labels:
            severity: info
          annotations:
            summary: "{{ $labels.project }}: High compaction rate - consider /clear between tasks"

        - alert: ClaudeCodeEditFailures
          expr: |
            sum(increase(claude_code_outcome_failure_total{tool_name="Edit"}[10m])) by (session_id) > 2
          for: 0m
          labels:
            severity: warning
          annotations:
            summary: "Multiple Edit failures - may need to re-read file"
